name: 'colcon_test'
description: 'Execute colcon test command with arguments given'

inputs:

  colcon_test_args:
    description: 'args to pass to colcon test command (use ctest_args to set ctest arguments)'
    required: false
    default: ''

  colcon_test_args_default:
    description: 'Default args to pass to colcon test command (use ctest_args to set ctest arguments)'
    required: false
    default: '--event-handlers=console_direct+ --return-code-on-test-failure'

  ctest_args:
    description: 'args to pass to colcon test command'
    required: false
    default: ''

  ctest_args_default:
    description: 'Default args to pass to colcon test command'
    required: false
    default: '--timeout 60'

  packages_names:
    description: 'Name of the colcon packages to build and test'
    required: true

  workspace:
    description: 'Workspace where built has been done'
    required: false
    default: '${{ github.workspace }}'

  workspace_dependencies:
    description: 'Workspace to source where dependencies are'
    required: false
    default: ''

runs:
  using: composite
  steps:

    - name: Run tests with colcon
      run: |

        echo "::group::Test colcon ${{ inputs.workspace }}"

        if [[ ! -z "${{ inputs.workspace_dependencies }}" ]]; then
          source ${{ inputs.workspace_dependencies }}/setup.bash
        fi

        cd ${{ inputs.workspace }}
        mkdir test_results

        echo "::endgroup::"

        for package in ${{ inputs.packages_names }}; do
          echo "::group::Testing ${package} ..."

          colcon test \
            ${{ inputs.colcon_test_args_default }} \
            ${{ inputs.colcon_test_args }} \
            --packages-select ${package}
            --ctest-args \
              ${{ inputs.ctest_args_default }} \
              ${{ inputs.ctest_args }} \
              --output-junit ${{ inputs.workspace }}/test_results/${package}_test_results.xml

          echo "::endgroup::"
        done

      shell: bash

    - name: Upload results
      uses: eProsima/eProsima-CI/external/upload-artifact@main
      if: success() || failure()
      with:
          name: test_results
          path: ${{ inputs.workspace }}/test_results
